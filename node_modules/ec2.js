var exec = require('child_process').exec;

var publicIp = null;
var privateIp = null;
var command = "ec2metadata";

// could put in code to check hostname -i and then do this if 127.* is returned
function getPublicIp (callback, bypassCache) {
	var filterRE = /public-ipv4.*/;

	// get cached value
	if (publicIp && !bypassCache) {
		callback(null, publicIp);
		return;
	}

	// system call
	exec(command, function (err, stdout, sterr) {
		if (err)
			return callback(err, null);

		var matches = stdout.match(filterRE);

		if (!matches)
			return callback("No match found for public-ipv4.", stdout);

		// assumes the first match
		var tokens = matches[0].split(":");

		if (tokens.length < 2) {
			callback("Incorrect format of ipv4 line: " + matches[0], null);
			return
		}

		publicIp = tokens[1].trim();
		callback(err, publicIp);
	});
}

module.exports = {
	getPublicIp: getPublicIp
};
